<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>åŒ¿è¯­é˜ | BABBLE</title>
    <link rel="stylesheet" type="text/css" href="/static/css/message.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

    <!-- å‘é€æˆåŠŸæç¤ºæ¡ -->
    <div class="success-toast" id="successToast">
        âœ… å‘é€æˆåŠŸï¼
        <button class="close-btn" onclick="hideSuccess()">Ã—</button>
    </div>

    <!-- ä¼šå‘˜éªŒè¯æ¨¡æ€æ¡† -->
    <div class="member-modal" id="memberModal">
        <div class="modal-content">
            <h3>ä¼šå‘˜éªŒè¯</h3>
            <p>è¯·è¾“å…¥4ä½ä¼šå‘˜å·</p>
            <input type="text" id="memberCode" placeholder="è¾“å…¥ä¼šå‘˜å·" maxlength="4">
            <div class="modal-buttons">
                <button class="modal-btn confirm" onclick="verifyMember()">éªŒè¯</button>
                <button class="modal-btn cancel" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div class="header">
        <a href="/index">è¿”å›é¦–é¡µ</a>
    </div>

    <div class="main">
        <h1 class="title">å¤šè°¢ä½¿ç”¨åŒ¿è¯­é˜ æ–°æ˜¥å¿«ä¹</h1>
        
        <!-- ç•™è¨€æäº¤è¡¨å• -->
        <form action="/upload" method="post" enctype="multipart/form-data" id="mainForm">
            <textarea class="todo_new" name="content" placeholder="å‘èµ·ä¸€ä¸ªæ–°è¯é¢˜" required></textarea>
            <br>
            <div class="upload-wrapper">
                <input type="file" name="image" accept="image/*" id="imageInput">
                <label for="imageInput">ğŸ“· ä¸Šä¼ å›¾ç‰‡-é™å…</label>
            </div>
            <p></p>
            <div class="button-group">
                <button type="submit" class="submit">æäº¤</button>
                <button type="button" class="member-btn" onclick="openModal('new')">å¼€å¯ç‚«å½©<br><span class="member-tag">å¿ƒåŠ¨PLUSä¼šå‘˜ä¸“äº«</span></button>
            </div>
            <input type="hidden" name="is_premium" id="newIsPremium" value="0">
        </form>

        <!-- ç•™è¨€åˆ—è¡¨å®¹å™¨ -->
        <div id="messages"></div>
    </div>

    <script>
    function isMemberVerified() {
        return localStorage.getItem('member_verified') === '1';
    }

    function setMemberVerified() {
        localStorage.setItem('member_verified', '1');
    }
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    let lastData = [];
    let currentFormType = ''; // 'new' æˆ– message_id
    const MEMBER_CODE = 'PZ01';

    function openModal(formType) {
        currentFormType = formType;
    
        document.getElementById('memberModal').style.display = 'flex';
    
        if (isMemberVerified()) {
            document.getElementById('memberCode').value = MEMBER_CODE;
        } else {
            document.getElementById('memberCode').value = '';
        }
    
        document.getElementById('memberCode').focus();
    }


    function closeModal() {
        document.getElementById('memberModal').style.display = 'none';
        document.getElementById('memberCode').value = '';
    }
    function applyPremium(formType) {
        if (formType === 'new') {
            document.getElementById('newIsPremium').value = '1';
            document.querySelector('.todo_new').classList.add('premium-border');
        } else {
            const form = document.querySelector(`.reply-form[data-id="${formType}"]`);
            if (form) {
                form.querySelector('textarea').classList.add('premium-border');
                localStorage.setItem(`premium_${formType}`, '1');
            }
        }
    }
    function verifyMember() {
        const inputCode = document.getElementById('memberCode').value.trim().toUpperCase();
    
        if (inputCode === MEMBER_CODE) {
    
            // âœ… 1. è®°å½•â€œå·²éªŒè¯ä¼šå‘˜â€
            localStorage.setItem('member_verified', '1');
    
            // âœ… 2. å¯¹å½“å‰æ“ä½œç›´æ¥åº”ç”¨ç‚«å½©
            applyPremium(currentFormType);
    
            closeModal();
            alert('âœ… ä¼šå‘˜éªŒè¯æˆåŠŸï¼');
    
        } else {
            alert('âŒ ä¼šå‘˜å·é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥');
            document.getElementById('memberCode').value = '';
            document.getElementById('memberCode').focus();
        }
    }


    // æ£€æŸ¥å›å¤çš„ä¼šå‘˜çŠ¶æ€
    function checkReplyPremium(messageId) {
        return localStorage.getItem(`premium_${messageId}`) === '1';
    }

    // æ˜¾ç¤ºæˆåŠŸæç¤º
    function showSuccess() {
        const toast = document.getElementById('successToast');
        toast.classList.add('show');
        // 5ç§’åè‡ªåŠ¨éšè—
        setTimeout(hideSuccess, 5000);
    }

    // éšè—æˆåŠŸæç¤º
    function hideSuccess() {
        const toast = document.getElementById('successToast');
        toast.classList.remove('show');
    }

    async function loadMessages() {
        try {
            const res = await fetch('/api/messages', { cache: "no-store" });
            if (!res.ok) {
                throw new Error(`HTTPé”™è¯¯: ${res.status}`);
            }
            const data = await res.json();
            const msgs = data.data;
            const container = document.getElementById('messages');

            const currentReplies = {};
            document.querySelectorAll('.reply-form textarea').forEach(t => {
                const id = t.closest('.reply-form').querySelector('input[name="message_id"]').value;
                const val = t.value.trim();
                if (val) currentReplies[id] = val;
            });

            // é‡è¦ä¿®æ”¹ï¼šç›´æ¥æ˜¾ç¤ºæ‰€æœ‰æ•°æ®ï¼Œä¸è¿›è¡Œè¿‡æ»¤
            if (lastData.length && JSON.stringify(msgs) === JSON.stringify(lastData)) return;
            lastData = msgs;

            let html = "";
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            if (msgs.length === 0) {
                html = `<div class="no-messages">è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼</div>`;
            } else {
                msgs.forEach(msg => {
                    let contentHtml = "";
                    const imgRegex = /\[å›¾ç‰‡]\(([^)]+)\)/g;
                    let lastIndex = 0;
                    let match;
                    while ((match = imgRegex.exec(msg.content)) !== null) {
                        if (match.index > lastIndex) {
                            const text = msg.content.substring(lastIndex, match.index);
                            contentHtml += escapeHtml(text).replace(/\n/g, "<br>");
                        }
                        let imageUrl = match[1];
                        if (!imageUrl.startsWith('/')) {
                            imageUrl = '/' + imageUrl;
                        }
                        contentHtml += `<img src="${escapeHtml(imageUrl)}" style="max-width:100%; border-radius:8px; margin:10px 0;">`;
                        lastIndex = imgRegex.lastIndex;
                    }
                    if (lastIndex < msg.content.length) {
                        const text = msg.content.substring(lastIndex);
                        contentHtml += escapeHtml(text).replace(/\n/g, "<br>");
                    }

                    // é‡è¦ä¿®æ”¹ï¼šæ— è®ºæ˜¯å¦ä¼šå‘˜ï¼Œéƒ½æ˜¾ç¤ºæ‰€æœ‰å†…å®¹
                    // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦æœ‰ç‚«å½©èƒŒæ™¯
                    const isPremiumMsg = msg.is_premium === '1' || msg.is_premium === 1;
                    
                    html += `
                    <div class="message ${isPremiumMsg ? 'premium-bg' : ''}" data-id="${msg.id}">
                        <div class="content">${contentHtml}</div>
                        <div class="date">${msg.date}</div>
                    
                        ${msg.replies.length ? `<div class="reply-box">` +
                            msg.replies.map(r => {
                                const isPremiumReply = r.is_premium === '1' || r.is_premium === 1;
                                return `
                                <div class="reply ${isPremiumReply ? 'premium-bg' : ''}">
                                    <div class="reply-content">${r.content}</div>
                                    <div class="reply-date">${r.date}</div>
                                </div>`;
                            }).join("")
                            + `</div>` : ""
                    }
                    
                        <form class="reply-form" data-id="${msg.id}">
                            <input type="hidden" name="message_id" value="${msg.id}">
                            <input type="hidden" name="is_premium" id="replyIsPremium_${msg.id}" value="0">
                            <textarea class="todo" name="reply_content" placeholder="å›å¤è¯¥ç•™è¨€" required></textarea>
                            <br>
                            <div class="button-group">
                                <button type="submit" class="submit">å›å¤</button>
                                <button type="button" class="member-btn" onclick="openModal('${msg.id}')">å¼€å¯ç‚«å½©<br><span class="member-tag">å¿ƒåŠ¨PLUSä¼šå‘˜ä¸“äº«</span></button>
                            </div>
                        </form>
                    </div>`;
                });
            }
            
            container.innerHTML = html;

            // æ¢å¤æ–‡æœ¬å†…å®¹å’Œä¼šå‘˜çŠ¶æ€
            Object.keys(currentReplies).forEach(id => {
                const form = container.querySelector(`.reply-form input[value="${id}"]`);
                if (form) {
                    const textarea = form.closest('.reply-form')?.querySelector('textarea');
                    if (textarea) {
                        textarea.value = currentReplies[id];
                        // æ¢å¤ä¼šå‘˜çŠ¶æ€
                        if (checkReplyPremium(id)) {
                            textarea.classList.add('premium-border');
                            document.getElementById(`replyIsPremium_${id}`).value = '1';
                        }
                    }
                }
            });

            document.querySelectorAll('.reply-form').forEach(form => {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    const messageId = form.querySelector('input[name="message_id"]').value;
                    const isPremium = checkReplyPremium(messageId) ? '1' : '0';
                    
                    const formData = new FormData(form);
                    formData.append('is_premium', isPremium);
                    
                    const res = await fetch('/reply', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await res.json();
                    if (result.status === "ok") {
                        console.log("å›å¤å·²æäº¤");
                        showSuccess();
                        // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                        localStorage.removeItem(`premium_${messageId}`);
                        setTimeout(loadMessages, 500);
                    } else {
                        alert(result.message || "æäº¤å¤±è´¥");
                    }
                };
            });
        } catch (error) {
            console.error("åŠ è½½æ¶ˆæ¯å¤±è´¥:", error);
            // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
            const container = document.getElementById('messages');
            container.innerHTML = `
                <div class="error-message">
                    <h3>ğŸ˜” åŠ è½½å¤±è´¥</h3>
                    <p>æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</p>
                    <button onclick="location.reload()">ğŸ”„ åˆ·æ–°é¡µé¢</button>
                </div>
            `;
        }
    }

    loadMessages();
    setInterval(loadMessages, 5000);

    // æŒ‰é’®æ³¢çº¹æ•ˆæœ
    document.querySelectorAll('.submit, .member-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            const ripple = document.createElement('span');
            ripple.classList.add('ripple');
            
            const rect = this.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
            ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';

            this.appendChild(ripple);
            ripple.addEventListener('animationend', () => {
                ripple.remove();
            });
        });
    });

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('memberModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // æŒ‰å›è½¦é”®éªŒè¯
    document.getElementById('memberCode').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            verifyMember();
        }
    });
    </script>
</body>
</html>
