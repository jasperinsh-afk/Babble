<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>匿语阁 | BETA</title>
    <link rel="stylesheet" type="text/css" href="/static/css/message.css"/>
</head>
<body>
    <div class="header">
        <a href="/index">返回起始页</a>
    </div>

    <div class="main">
        <h1 class="title">欢迎使用匿语阁！</h1>

        <!-- 留言提交表单（不被刷新覆盖） -->
        <form action="/upload" method="post">
            <textarea class="todo_new" name="content" placeholder="发起一个新话题" required></textarea>
            <br>
            <button class="submit">提交</button>
        </form>

        <!-- 留言列表容器 -->
        <div id="messages"></div>
    </div>

    <script>
    let lastData = [];
    
    async function loadMessages(){
        const res = await fetch('/api/messages');
        const data = await res.json();
        const msgs = data.data;
        const container = document.getElementById('messages');
    
        // 提取当前用户还没提交的回复内容（键为 message_id）
        const currentReplies = {};
        document.querySelectorAll('.reply-form textarea').forEach(t=>{
            const id = t.closest('.reply-form').querySelector('input[name="message_id"]').value;
            const val = t.value.trim();
            if (val) currentReplies[id] = val;
        });
    
        // 如果新数据与旧数据完全相同，不刷新（减少无意义重渲）
        if (JSON.stringify(msgs) === JSON.stringify(lastData)) return;
        lastData = msgs;
    
        let html = "";
        msgs.forEach(msg=>{
            html += `
            <div class="message" data-id="${msg.id}">
                <div class="content">${msg.content}</div>
                <div class="date">${msg.date}</div>
    
                ${msg.replies.length ? `<div class="reply-box">`+
                    msg.replies.map(r=>`
                        <div class="reply">
                            <div class="reply-content">${r.content}</div>
                            <div class="reply-date">${r.date}</div>
                        </div>`).join("")
                    +`</div>` : ""
                }
    
                <form action="/reply" method="post" class="reply-form">
                    <input type="hidden" name="message_id" value="${msg.id}">
                    <textarea class="todo" name="reply_content" placeholder="回复该留言..." required></textarea>
                    <br>
                    <button class="submit">回复</button>
                </form>
            </div>`;
        });
        container.innerHTML = html;
    
        // 恢复用户未提交的输入内容
        Object.keys(currentReplies).forEach(id=>{
            const textarea = container.querySelector(`.reply-form input[value="${id}"]`)?.parentElement.querySelector('textarea');
            if (textarea) textarea.value = currentReplies[id];
        });
    }
    
    // 首次加载消息
    loadMessages();
    // 每隔 5 秒刷新一次
    setInterval(loadMessages, 5000);

    </script>
</body>
</html>
