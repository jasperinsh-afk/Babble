<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>匿语阁 | BETA</title>
    <link rel="stylesheet" type="text/css" href="/static/css/message.css"/>
</head>
    
<script>
async function loadMessages(){
    const res = await fetch('/api/messages');
    const data = await res.json();
    const container = document.querySelector('.main');
    let html = `
        <h1 class="title">欢迎使用匿语阁！</h1>
        <form action="/upload" method="post">
            <textarea class="todo_new" name="content" placeholder="发起一个新话题" required></textarea><br>
            <button class="submit">提交</button>
        </form>
    `;
    data.data.forEach(msg=>{
        html += `
        <div class="message">
            <div class="content">${msg.content}</div>
            <div class="date">${msg.date}</div>
            ${msg.replies.length ? `<div class="reply-box">`+ 
                msg.replies.map(r=>`
                    <div class="reply">
                        <div class="reply-content">${r.content}</div>
                        <div class="reply-date">${r.date}</div>
                    </div>`).join("")
                +`</div>` : ""
            }
            <form action="/reply" method="post" class="reply-form">
                <input type="hidden" name="message_id" value="${msg.id}">
                <textarea class="todo" name="reply_content" placeholder="回复该留言..." required></textarea><br>
                <button class="submit">回复</button>
            </form>
        </div>`;
    });
    container.innerHTML = html;
}

// 初次加载
loadMessages();
// 每隔5秒刷新
setInterval(loadMessages, 5000);
</script>

<body>
    <div class="header">
        <a href="/index">返回起始页</a>
    </div>

    <div class="main">
        <h1 class="title">欢迎使用匿语阁！</h1>

        <!-- 留言提交 -->
        <form action="/upload" method="post">
            <textarea class="todo_new" name="content" placeholder="发起一个新话题" required></textarea>
            <br>
            <button class="submit">提交</button>
        </form>

        <!-- 展示留言 -->
        {% for msg in data %}
        <div class="message">
            <div class="content">{{ msg.content }}</div>
            <div class="date">{{ msg.date }}</div>

            {% if msg.replies %}
            <div class="reply-box">
                {% for r in msg.replies %}
                <div class="reply">
                    <div class="reply-content">{{ r.content }}</div>
                    <div class="reply-date">{{ r.date }}</div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- 回复表单 -->
            <form action="/reply" method="post" class="reply-form">
                <input type="hidden" name="message_id" value="{{ msg.id }}">
                <textarea class="todo" name="reply_content" placeholder="回复该留言..." required></textarea>
                <br>
                <button class="submit">回复</button>
            </form>
        </div>
        {% endfor %}
    </div>
</body>
</html>
