<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>åŒ¿è¯­é˜ | BABBLE</title>
    <link rel="stylesheet" type="text/css" href="/static/css/message.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

    <!-- å‘é€æˆåŠŸæç¤ºæ¡ -->
    <div class="success-toast" id="successToast">
        âœ… å‘é€æˆåŠŸï¼
        <button class="close-btn" onclick="hideSuccess()">Ã—</button>
    </div>

    <div class="header">
        <a href="/index">è¿”å›é¦–é¡µ</a>
    </div>

    <div class="main">
        <h1 class="title">ç¥å¤§å®¶åœ¨æ–°çš„ä¸€å¹´ä¸‡äº‹å¦‚æ„ï¼Œé©¬åˆ°æˆåŠŸï¼</h1>
        
        <!-- ç•™è¨€æäº¤è¡¨å• -->
        <form action="/upload" method="post" enctype="multipart/form-data">
            <textarea class="todo_new" name="content" placeholder="å‘èµ·ä¸€ä¸ªæ–°è¯é¢˜" required></textarea>
            <br>
            <div class="upload-wrapper">
                <input type="file" name="image" accept="image/*" id="imageInput">
                <label for="imageInput">ğŸ“· ä¸Šä¼ å›¾ç‰‡</label>
            </div>
            <p></p>
            <button class="submit">æäº¤</button>
        </form>

        <!-- ç•™è¨€åˆ—è¡¨å®¹å™¨ -->
        <div id="messages"></div>
    </div>

    <script>
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    let lastData = [];

    // æ˜¾ç¤ºæˆåŠŸæç¤º
    function showSuccess() {
        const toast = document.getElementById('successToast');
        toast.classList.add('show');
        // 5ç§’åè‡ªåŠ¨éšè—
        setTimeout(hideSuccess, 5000);
    }

    // éšè—æˆåŠŸæç¤º
    function hideSuccess() {
        const toast = document.getElementById('successToast');
        toast.classList.remove('show');
    }

    async function loadMessages() {
        const res = await fetch('/api/messages', { cache: "no-store" });
        const data = await res.json();
        const msgs = data.data;
        const container = document.getElementById('messages');

        const currentReplies = {};
        document.querySelectorAll('.reply-form textarea').forEach(t => {
            const id = t.closest('.reply-form').querySelector('input[name="message_id"]').value;
            const val = t.value.trim();
            if (val) currentReplies[id] = val;
        });

        if (lastData.length && JSON.stringify(msgs) === JSON.stringify(lastData)) return;
        lastData = msgs;

        let html = "";
        msgs.forEach(msg => {
            let contentHtml = "";
            const imgRegex = /\[å›¾ç‰‡]\(([^)]+)\)/g;
            let lastIndex = 0;
            let match;
            while ((match = imgRegex.exec(msg.content)) !== null) {
                if (match.index > lastIndex) {
                    const text = msg.content.substring(lastIndex, match.index);
                    contentHtml += escapeHtml(text).replace(/\n/g, "<br>");
                }
                let imageUrl = match[1];
                if (!imageUrl.startsWith('/')) {
                    imageUrl = '/' + imageUrl;
                }
                contentHtml += `<img src="${escapeHtml(imageUrl)}" style="max-width:100%; border-radius:8px; margin:10px 0;">`;
                lastIndex = imgRegex.lastIndex;
            }
            if (lastIndex < msg.content.length) {
                const text = msg.content.substring(lastIndex);
                contentHtml += escapeHtml(text).replace(/\n/g, "<br>");
            }

            html += `
            <div class="message" data-id="${msg.id}">
                <div class="content">${contentHtml}</div>
                <div class="date">${msg.date}</div>
            
                ${msg.replies.length ? `<div class="reply-box">` +
                    msg.replies.map(r => `
                        <div class="reply">
                            <div class="reply-content">${r.content}</div>
                            <div class="reply-date">${r.date}</div>
                        </div>`).join("")
                    + `</div>` : ""
            }
            
                <form class="reply-form" data-id="${msg.id}">
                    <input type="hidden" name="message_id" value="${msg.id}">
                    <textarea class="todo" name="reply_content" placeholder="å›å¤è¯¥ç•™è¨€" required></textarea>
                    <br>
                    <button class="submit">å›å¤</button>
                </form>
            </div>`;
        });
        container.innerHTML = html;

        Object.keys(currentReplies).forEach(id => {
            const form = container.querySelector(`.reply-form input[value="${id}"]`);
            if (form) {
                const textarea = form.closest('.reply-form')?.querySelector('textarea');
                if (textarea) textarea.value = currentReplies[id];
            }
        });

        document.querySelectorAll('.reply-form').forEach(form => {
            form.onsubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const res = await fetch('/reply', {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                if (result.status === "ok") {
                    console.log("å›å¤å·²æäº¤");
                    showSuccess(); // â† å›å¤æˆåŠŸæç¤º
                    setTimeout(loadMessages, 500);
                } else {
                    alert(result.message || "æäº¤å¤±è´¥");
                }
            };
        });
    }

    loadMessages();
    setInterval(loadMessages, 5000);

    // æŒ‰é’®æ³¢çº¹æ•ˆæœ
    document.querySelectorAll('.submit').forEach(button => {
        button.addEventListener('click', function(e) {
            const ripple = document.createElement('span');
            ripple.classList.add('ripple');
            
            const rect = this.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
            ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';

            this.appendChild(ripple);
            ripple.addEventListener('animationend', () => {
                ripple.remove();
            });
        });
    });
    </script>
</body>
</html>
