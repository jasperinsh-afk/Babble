<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>åŒ¿è¯­é˜ | BABBLE</title>
    <link rel="stylesheet" type="text/css" href="/static/css/message.css"/>
</head>
<body>
    <div class="header">
        <a href="/index">è¿”å›é¦–é¡µ</a>
    </div>

    <div class="main">

        <!-- ç•™è¨€æäº¤è¡¨å•ï¼ˆä¸è¢«åˆ·æ–°è¦†ç›–ï¼‰ -->
        <form action="/upload" method="post">
            <textarea class="todo_new" name="content" placeholder="å‘èµ·ä¸€ä¸ªæ–°è¯é¢˜" required></textarea>
            <br>
            <button class="submit">æäº¤</button>
        </form>

        <!-- ç•™è¨€åˆ—è¡¨å®¹å™¨ -->
        <div id="messages"></div>
    </div>

    <script>
    <script>
let lastData = [];

async function loadMessages(){
    const res = await fetch('/api/messages');
    const data = await res.json();
    const msgs = data.data;
    const container = document.getElementById('messages');

    // ä¿ç•™ç”¨æˆ·æœªæäº¤è¾“å…¥
    const currentReplies = {};
    document.querySelectorAll('.reply-form textarea').forEach(t=>{
        const id = t.closest('.reply-form').querySelector('input[name="message_id"]').value;
        const val = t.value.trim();
        if (val) currentReplies[id] = val;
    });

    if (JSON.stringify(msgs) === JSON.stringify(lastData)) return;
    lastData = msgs;

    let html = "";
    msgs.forEach(msg=>{
        html += `
        <div class="message" data-id="${msg.id}">
            <div class="content">${msg.content}</div>
            <div class="date">${msg.date}</div>

            ${msg.replies.length ? `<div class="reply-box">`+
                msg.replies.map(r=>`
                    <div class="reply">
                        <div class="reply-content">${r.content}</div>
                        <div class="reply-date">${r.date}</div>
                    </div>`).join("")
                +`</div>` : ""
            }

            <form class="reply-form" data-id="${msg.id}">
                <input type="hidden" name="message_id" value="${msg.id}">
                <textarea name="reply_content" placeholder="å›å¤è¯¥ç•™è¨€" required></textarea>
                <br>
                <button type="submit">å›å¤</button>
            </form>
        </div>`;
    });
    container.innerHTML = html;

    // æ¢å¤ç”¨æˆ·è¾“å…¥
    Object.keys(currentReplies).forEach(id=>{
        const textarea = container.querySelector(`.reply-form input[value="${id}"]`)?.parentElement.querySelector('textarea');
        if (textarea) textarea.value = currentReplies[id];
    });

    // ğŸ”¥ é‡æ–°ç»‘å®š form çš„æäº¤äº‹ä»¶ï¼ˆå¼‚æ­¥å‘ç»™åç«¯ï¼‰
    document.querySelectorAll('.reply-form').forEach(form=>{
        form.onsubmit = async (e)=>{
            e.preventDefault(); // é˜»æ­¢è·³è½¬
            const formData = new FormData(form);
            const res = await fetch('/reply', {
                method: 'POST',
                body: formData
            });

            if(res.ok){
                console.log("å›å¤å·²æäº¤");
                // åˆ·æ–°ä¸€æ¬¡ç•™è¨€æ˜¾ç¤º
                setTimeout(loadMessages, 500);
            }else{
                alert("æäº¤å¤±è´¥ï¼");
            }
        }
    });
}

// åˆå§‹åŒ–åŠ è½½
loadMessages();
setInterval(loadMessages, 5000);
</script>


    </script>
</body>
</html>
